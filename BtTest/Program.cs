using System.Diagnostics;
using Microsoft.SPOT;
using Nrf8001Lib;
using Nrf8001Lib.Commands;
using Nrf8001Lib.Events;
using SecretLabs.NETMF.Hardware.NetduinoPlus;
using Microsoft.SPOT.Hardware;
using System.Threading;

namespace BtTest
{
    public class Program
    {
        const int TriggerStatePipeId = 1;

        private readonly byte[][] SetupData = new byte[][] {
            new byte[] {0x00,0x00,0x02,0x02,0x41,0xfe,},
            new byte[] {0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x06,0x00,0x01,0xc1,0x10,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,},
            new byte[] {0x10,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x03,0x90,0x00,},
            new byte[] {0x20,0x00,0x04,0x04,0x02,0x02,0x00,0x01,0x28,0x00,0x01,0x00,0x18,0x04,0x04,0x05,0x05,0x00,0x02,0x28,0x03,0x01,0x02,0x03,0x00,0x00,0x2a,0x04,0x04,0x14,},
            new byte[] {0x20,0x1c,0x0e,0x00,0x03,0x2a,0x00,0x01,0x4c,0x61,0x73,0x65,0x72,0x54,0x61,0x67,0x20,0x47,0x75,0x6e,0x20,0x31,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x04,},
            new byte[] {0x20,0x38,0x05,0x05,0x00,0x04,0x28,0x03,0x01,0x02,0x05,0x00,0x01,0x2a,0x06,0x04,0x03,0x02,0x00,0x05,0x2a,0x01,0x01,0x10,0xff,0x04,0x04,0x05,0x05,0x00,},
            new byte[] {0x20,0x54,0x06,0x28,0x03,0x01,0x02,0x07,0x00,0x04,0x2a,0x06,0x04,0x09,0x08,0x00,0x07,0x2a,0x04,0x01,0xff,0xff,0xff,0xff,0x00,0x00,0xff,0xff,0x04,0x04,},
            new byte[] {0x20,0x70,0x02,0x02,0x00,0x08,0x28,0x00,0x01,0x01,0x18,0x04,0x04,0x02,0x02,0x00,0x09,0x28,0x00,0x01,0x10,0xff,0x04,0x04,0x05,0x05,0x00,0x0a,0x28,0x03,},
            new byte[] {0x20,0x8c,0x01,0x12,0x0b,0x00,0x11,0xff,0x16,0x04,0x02,0x01,0x00,0x0b,0xff,0x11,0x01,0x00,0x46,0x14,0x03,0x02,0x00,0x0c,0x29,0x02,0x01,0x00,0x00,0x00,},
            new byte[] {0x40,0x00,0xff,0x11,0x01,0x00,0x02,0x04,0x00,0x0b,0x00,0x0c,},
            new byte[] {0xf0,0x00,0x02,0xb2,0x2e,},
        };

        private Nrf8001 _nrf;
        private OutputPort _led = new OutputPort(Pins.ONBOARD_LED, false);

        public Program()
        {
            _nrf = new Nrf8001(Pins.GPIO_PIN_D4, Pins.GPIO_PIN_D2, Pins.GPIO_PIN_D3, SPI_Devices.SPI1);

            // Setup device
            DoSetup();
            
            // Wait for a connection
            _led.Write(true);
            WaitForConnect();

            // We are now connected
            _led.Write(false);

            byte notData = 0x01;

            while (true)
            {
                _nrf.HandleEvent();

                notData = (byte)(notData == 0 ? 0x01 : 0);

                _nrf.SendData(TriggerStatePipeId, notData);

                Thread.Sleep(1000);
            }
        }

        private bool DoSetup()
        {
            while (_nrf.State != Nrf8001State.Setup)
                _nrf.HandleEvent();

            int setupIndex = 0;
            _nrf.Setup(SetupData[setupIndex++]);

            while (true)
            {
                var nrfEvent = _nrf.HandleEvent();

                if (nrfEvent == null)
                    continue;

                if (nrfEvent.EventType == Nrf8001EventType.CommandResponse && nrfEvent.Data[1] == (byte)Nrf8001OpCode.Setup)
                {
                    if (nrfEvent.Data[2] == (byte)Nrf8001AciStatusCode.TransactionContinue)
                        _nrf.Setup(SetupData[setupIndex++]);
                    else if (nrfEvent.Data[2] != (byte)Nrf8001AciStatusCode.TransactionComplete)
                        return false;
                }
                else if (nrfEvent.EventType == Nrf8001EventType.DeviceStarted)
                {
                    return true;
                }
            }
        }

        private void WaitForConnect()
        {
            _nrf.Connect(15, 32);

            while (true)
            {
                var nrfEvent = _nrf.HandleEvent();

                if (nrfEvent == null)
                    continue;

                if (nrfEvent.EventType == Nrf8001EventType.PipeStatus && _nrf.OpenPipesBitmap > 1)
                    return;
                else if (nrfEvent.EventType == Nrf8001EventType.Disconnected)
                    _nrf.Connect(15, 32);
            }
        }

        public static void Main()
        {
            new Program();            
        }
    }
}
